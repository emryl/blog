<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    <title>Setup Split VPN on Unifi USG Using PBR | Lots of emryl</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="unifi,vpn,usg" />
    
    <meta name="description" content="This is a writeup for setting up a client OpenVPN (or any other VPN type) connection, but only use it for some clients&#x2F;VLANS. I’m setting things up using a Unifi USG and the special config file. Since">
<meta property="og:type" content="article">
<meta property="og:title" content="Setup Split VPN on Unifi USG Using PBR">
<meta property="og:url" content="https://blog.rylander.io/2018/01/07/setup-split-vpn-on-unifi-usg-using-pbr/index.html">
<meta property="og:site_name" content="Lots of emryl">
<meta property="og:description" content="This is a writeup for setting up a client OpenVPN (or any other VPN type) connection, but only use it for some clients&#x2F;VLANS. I’m setting things up using a Unifi USG and the special config file. Since">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.rylander.io/2018/01/07/setup-split-vpn-on-unifi-usg-using-pbr/15a5add2-233c-465d-9d6b-78628d214491.jpg">
<meta property="article:published_time" content="2018-01-07T20:28:34.000Z">
<meta property="article:modified_time" content="2018-01-07T20:28:34.000Z">
<meta property="article:author" content="emryl">
<meta property="article:tag" content="unifi">
<meta property="article:tag" content="vpn">
<meta property="article:tag" content="usg">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.rylander.io/2018/01/07/setup-split-vpn-on-unifi-usg-using-pbr/15a5add2-233c-465d-9d6b-78628d214491.jpg">
    

    

    
        <link rel="icon" href="/images/favicon.ico" />
    

    <script type="text/javascript">
        window.NREUM||(NREUM={}),__nr_require=function(e,t,n){function r(n){if(!t[n]){var o=t[n]={exports:{}};e[n][0].call(o.exports,function(t){var o=e[n][1][t];return r(o||t)},o,o.exports)}return t[n].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<n.length;o++)r(n[o]);return r}({1:[function(e,t,n){function r(){}function o(e,t,n){return function(){return i(e,[f.now()].concat(u(arguments)),t?null:this,n),t?void 0:this}}var i=e("handle"),a=e(2),u=e(3),c=e("ee").get("tracer"),f=e("loader"),s=NREUM;"undefined"==typeof window.newrelic&&(newrelic=s);var p=["setPageViewName","setCustomAttribute","setErrorHandler","finished","addToTrace","inlineHit","addRelease"],d="api-",l=d+"ixn-";a(p,function(e,t){s[t]=o(d+t,!0,"api")}),s.addPageAction=o(d+"addPageAction",!0),s.setCurrentRouteName=o(d+"routeName",!0),t.exports=newrelic,s.interaction=function(){return(new r).get()};var m=r.prototype={createTracer:function(e,t){var n={},r=this,o="function"==typeof t;return i(l+"tracer",[f.now(),e,n],r),function(){if(c.emit((o?"":"no-")+"fn-start",[f.now(),r,o],n),o)try{return t.apply(this,arguments)}catch(e){throw c.emit("fn-err",[arguments,this,e],n),e}finally{c.emit("fn-end",[f.now()],n)}}}};a("setName,setAttribute,save,ignore,onEnd,getContext,end,get".split(","),function(e,t){m[t]=o(l+t)}),newrelic.noticeError=function(e){"string"==typeof e&&(e=new Error(e)),i("err",[e,f.now()])}},{}],2:[function(e,t,n){function r(e,t){var n=[],r="",i=0;for(r in e)o.call(e,r)&&(n[i]=t(r,e[r]),i+=1);return n}var o=Object.prototype.hasOwnProperty;t.exports=r},{}],3:[function(e,t,n){function r(e,t,n){t||(t=0),"undefined"==typeof n&&(n=e?e.length:0);for(var r=-1,o=n-t||0,i=Array(o<0?0:o);++r<o;)i[r]=e[t+r];return i}t.exports=r},{}],4:[function(e,t,n){t.exports={exists:"undefined"!=typeof window.performance&&window.performance.timing&&"undefined"!=typeof window.performance.timing.navigationStart}},{}],ee:[function(e,t,n){function r(){}function o(e){function t(e){return e&&e instanceof r?e:e?c(e,u,i):i()}function n(n,r,o,i){if(!d.aborted||i){e&&e(n,r,o);for(var a=t(o),u=m(n),c=u.length,f=0;f<c;f++)u[f].apply(a,r);var p=s[y[n]];return p&&p.push([b,n,r,a]),a}}function l(e,t){v[e]=m(e).concat(t)}function m(e){return v[e]||[]}function w(e){return p[e]=p[e]||o(n)}function g(e,t){f(e,function(e,n){t=t||"feature",y[n]=t,t in s||(s[t]=[])})}var v={},y={},b={on:l,emit:n,get:w,listeners:m,context:t,buffer:g,abort:a,aborted:!1};return b}function i(){return new r}function a(){(s.api||s.feature)&&(d.aborted=!0,s=d.backlog={})}var u="nr@context",c=e("gos"),f=e(2),s={},p={},d=t.exports=o();d.backlog=s},{}],gos:[function(e,t,n){function r(e,t,n){if(o.call(e,t))return e[t];var r=n();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(e,t,{value:r,writable:!0,enumerable:!1}),r}catch(i){}return e[t]=r,r}var o=Object.prototype.hasOwnProperty;t.exports=r},{}],handle:[function(e,t,n){function r(e,t,n,r){o.buffer([e],r),o.emit(e,t,n)}var o=e("ee").get("handle");t.exports=r,r.ee=o},{}],id:[function(e,t,n){function r(e){var t=typeof e;return!e||"object"!==t&&"function"!==t?-1:e===window?0:a(e,i,function(){return o++})}var o=1,i="nr@id",a=e("gos");t.exports=r},{}],loader:[function(e,t,n){function r(){if(!x++){var e=h.info=NREUM.info,t=d.getElementsByTagName("script")[0];if(setTimeout(s.abort,3e4),!(e&&e.licenseKey&&e.applicationID&&t))return s.abort();f(y,function(t,n){e[t]||(e[t]=n)}),c("mark",["onload",a()+h.offset],null,"api");var n=d.createElement("script");n.src="https://"+e.agent,t.parentNode.insertBefore(n,t)}}function o(){"complete"===d.readyState&&i()}function i(){c("mark",["domContent",a()+h.offset],null,"api")}function a(){return E.exists&&performance.now?Math.round(performance.now()):(u=Math.max((new Date).getTime(),u))-h.offset}var u=(new Date).getTime(),c=e("handle"),f=e(2),s=e("ee"),p=window,d=p.document,l="addEventListener",m="attachEvent",w=p.XMLHttpRequest,g=w&&w.prototype;NREUM.o={ST:setTimeout,SI:p.setImmediate,CT:clearTimeout,XHR:w,REQ:p.Request,EV:p.Event,PR:p.Promise,MO:p.MutationObserver};var v=""+location,y={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-1071.min.js"},b=w&&g&&g[l]&&!/CriOS/.test(navigator.userAgent),h=t.exports={offset:u,now:a,origin:v,features:{},xhrWrappable:b};e(1),d[l]?(d[l]("DOMContentLoaded",i,!1),p[l]("load",r,!1)):(d[m]("onreadystatechange",o),p[m]("onload",r)),c("mark",["firstbyte",u],null,"api");var x=0,E=e(4)},{}]},{},["loader"]);
        ;NREUM.info={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",licenseKey:"61d58eabe5",applicationID:"102468771",sa:1}
    </script>        

    
<link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/vendor/titillium-web/styles.css">

    
<link rel="stylesheet" href="/vendor/source-code-pro/styles.css">


    
<link rel="stylesheet" href="/css/style.css">


    
<script src="/vendor/jquery/2.0.3/jquery.min.js"></script>

    
    
        
<link rel="stylesheet" href="/vendor/fancybox/jquery.fancybox.css">

    
    
        
<link rel="stylesheet" href="/vendor/scrollLoading/style.css">

    
    
        <script type="text/javascript">
(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-58006445-2', 'auto');
ga('send', 'pageview');

</script>
    
    

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">Home</a>
                                </li>
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/homelab/index.html">Home Lab</a>
                                </li>
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/about/index.html">About</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="https://blog.rylander.io"></form>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    Blog
    </h1>
</div>
                        <div class="main-body-content">
                            <article id="post-setup-split-vpn-on-unifi-usg-using-pbr" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        Setup Split VPN on Unifi USG Using PBR
        </h1>
    

            </header>
        
        <div class="article-subtitle">
            <a href="/2018/01/07/setup-split-vpn-on-unifi-usg-using-pbr/" class="article-date">
    <time datetime="2018-01-07T20:28:34.000Z" itemprop="datePublished">2018-01-07</time>
</a>
            
    <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/unifi/" rel="tag">unifi</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/usg/" rel="tag">usg</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vpn/" rel="tag">vpn</a></li></ul>

        </div>
        <div class="article-entry" itemprop="articleBody">
            <p>This is a writeup for setting up a client OpenVPN (or any other VPN type) connection, but only use it for some clients/VLANS. I’m setting things up using a Unifi USG and the special config file. Since the UI is currently not supported for client OpenVPN configuration, although support is on the roadmap, this will show it is actually quite easy to setup.</p>
<p>As the UI is not yet supporting the configuration, the neccessary configuration needs to be entered into the special config.gateway.json file on the controller. The usual way to do this is to use the cli on the USG, do the configuration and then export the json and copy parts of it to the config.gateway.json file. I’ve done this, so you can easily just copy from my configuration and then edit the parts you want.</p>
<p>I’m reusing the work from Travis Cook’s <a href="https://github.com/TravisCook/Detour" target="_blank" rel="noopener">Detour</a> in order to be able to select which device is using the VPN tunnel. It is making use of PBR and provides a UI to add predefined clients (really their IP address) to the list of IPs that are routed via the VPN. I’m using this mostly to access Netflix and similar services from ATVs and the like. I actually use a pptp VPN due to speed, but OpenVPN does perform with a single stream.</p>
<p>Known caveats: Som earlier revision of the USG firmware had a broken PBR. Guess how I know this!</p>
<img src="/2018/01/07/setup-split-vpn-on-unifi-usg-using-pbr/15a5add2-233c-465d-9d6b-78628d214491.jpg" class="">

<h2 id="Get-familiar-with-the-config-json-structure-on-the-USG"><a href="#Get-familiar-with-the-config-json-structure-on-the-USG" class="headerlink" title="Get familiar with the config.json structure on the USG"></a>Get familiar with the config.json structure on the USG</h2><p>To get a formatted copy of the config.json file on your controller, you can dump the current configuration from your USG into a formatted file. Login to the USG and use the existing utility to create the file. I named my file with the suffix .json since I want my text editor to help out with formatting. Transfer the file back your computer for easy editing. I’m using Transmit since I’m on a Mac. Once the file is on your computer, use your favorite editing tool to open it. I use Visual Studio Code.</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh <span class="symbol">admin@</span><span class="number">10.0</span><span class="number">.1</span><span class="number">.1</span>*</span><br><span class="line">mca-ctrl -t dump-cfg &gt; config.json*</span><br><span class="line"> </span><br></pre></td></tr></table></figure>


<p><em>To have the whole thing collapse, Ctrl/Cmd-K + Ctl/Cmd-0</em></p>
<p>*This way you see the top most nodes and their relative structure. In our own file, we will add configuration to several nodes, but not all and we can therefore copy the nodes we need including their structure. *</p>
<img src="/2018/01/07/setup-split-vpn-on-unifi-usg-using-pbr/get-familiar-with-the-configjson-structure-on-the-usg.png" class="">

<h3 id="Location-of-the-config-gateway-json-file"><a href="#Location-of-the-config-gateway-json-file" class="headerlink" title="Location of the config.gateway.json file"></a>Location of the config.gateway.json file</h3><p>So the Unifi Controller provides an easy way to inject additional configuration. The location is site specific.</p>
<p>Since I’m running the Controller in a Docker container, I’ve chosen to expose most data and configuration outside of the container instance and I’m using a plain share since I’m hosting my Docker on a Synology NAS.</p>
<p>The controller merges this configuration when provisioning the USG device. If there are errors in this file, the provisioning process may end up in a loop so make sure to check the logs and the alert view in the Controller. I export all USG logs to a syslog server, which is handy to check for errors. You can also check the logs locally on the USG.</p>
<img src="/2018/01/07/setup-split-vpn-on-unifi-usg-using-pbr/location-of-the-configgatewayjson-file.png" class="">

<h2 id="Overview-of-the-OpenVPN-settings-on-the-USG"><a href="#Overview-of-the-OpenVPN-settings-on-the-USG" class="headerlink" title="Overview of the OpenVPN settings on the USG"></a>Overview of the OpenVPN settings on the USG</h2><p>I highly recommend to only configure the OpenVPN connection first, to ensure the VPN actually works before proceeding with anything. </p>
<p>The OpenVPN configuration is placed into a local file on the USG. An additional credentials file is created.</p>
<p>Create the folder /config/openvpn on the USG</p>
<p>We place two files within this directory:</p>
<ul>
<li>The credentials file containing username and password</li>
<li>The client configuration file, specific to your chosen OpenVPN provider</li>
</ul>
<p>The OpenVPN client configuration is specific to your provider. I use Giganews/VyprVPN and the settings are retrieved from their sample files. I did need to add configuration to not pull and overwrite my Gateway and routing settings.</p>
<p>Actually we have three files, where one is copy of the other. Since I have several configuration files, I just copy the current file over the generic one. Initially I did want to use a symbolic link, but that didn’t work as expected.</p>
<img src="/2018/01/07/setup-split-vpn-on-unifi-usg-using-pbr/overview-of-the-openvpn-settings-on-the-usg.png" class="">

<h3 id="Create-the-credentials-file"><a href="#Create-the-credentials-file" class="headerlink" title="Create the credentials file"></a>Create the credentials file</h3><p>Create the file /config/openvpn/password_filename. Provide you own username/password on two separate lines.</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">username</span></span><br><span class="line"><span class="attribute">password</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure>


<img src="/2018/01/07/setup-split-vpn-on-unifi-usg-using-pbr/create-the-credentials-file.png" class="">

<h3 id="Create-the-configuration-file-for-openvpn"><a href="#Create-the-configuration-file-for-openvpn" class="headerlink" title="Create the configuration file for openvpn"></a>Create the configuration file for openvpn</h3><p>Create the file /config/openvpn/gateway.ovpn containing the following:</p>
<p>I added the route-noexec parameter in order to block the VPN from overwriting my default routes and gateway settings.</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">#  _____ <span class="keyword">_</span>         _____               </span><br><span class="line"># |   <span class="type">__</span>|<span class="type">_</span>|<span class="type">___</span> ___|   <span class="type">| |___</span> <span class="keyword">_</span> <span class="keyword">_</span> <span class="keyword">_</span> ___ </span><br><span class="line"># |  <span class="type">|  | | . | .'| | | | -_</span>| <span class="type">| | |_</span> -|<span class="type"></span></span><br><span class="line"><span class="type"># |_____</span>|<span class="type">_</span>|<span class="type">_</span>  |<span class="type">__</span>,|<span class="type">_</span>|<span class="type">___</span>|<span class="type">___</span>|<span class="type">_____</span>|<span class="type">___</span>|<span class="type"></span></span><br><span class="line"><span class="type">#         |___</span>|                        <span class="type"></span></span><br><span class="line"><span class="type"></span></span><br><span class="line"><span class="type">client</span></span><br><span class="line">dev tun</span><br><span class="line">proto udp</span><br><span class="line">remote us5.vpn.giganews.com <span class="number">443</span></span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">persist-remote-ip</span><br><span class="line">;ca ca.vyprvpn.com.crt</span><br><span class="line">tls-remote us5.vpn.giganews.com</span><br><span class="line">auth-user-pass /config/openvpn/giganewsauth.txt</span><br><span class="line">comp-lzo</span><br><span class="line">verb <span class="number">3</span></span><br><span class="line">auth SHA256</span><br><span class="line">cipher AES<span class="number">-256</span>-CBC</span><br><span class="line">keysize <span class="number">256</span></span><br><span class="line">tls-cipher DHE-RSA-AES256-SHA:DHE-DSS-AES256-SHA:AES256-SHA</span><br><span class="line">route-noexec</span><br><span class="line">#route-nopull</span><br><span class="line"></span><br><span class="line">&lt;ca&gt;</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIEpDCCA4ygAwIBAgIJANd2Uwt7SabsMA0GCSqGSIb3DQEBBQUAMIGSMQswCQYD</span><br><span class="line">VQQGEwJLWTEUMBIGA1UECBMLR3JhbmRDYXltYW4xEzARBgNVBAcTCkdlb3JnZVRv</span><br><span class="line">d24xFzAVBgNVBAoTDkdvbGRlbkZyb2ctSW5jMRowGAYDVQQDExFHb2xkZW5Gcm9n</span><br><span class="line">LUluYyBDQTEjMCEGCSqGSIb3DQEJARYUYWRtaW5AZ29sZGVuZnJvZy5jb20wHhcN</span><br><span class="line">MTAwNDA5MjExOTIxWhcNMjAwNDA2MjExOTIxWjCBkjELMAkGA1UEBhMCS1kxFDAS</span><br><span class="line">BgNVBAgTC0dyYW5kQ2F5bWFuMRMwEQYDVQQHEwpHZW9yZ2VUb3duMRcwFQYDVQQK</span><br><span class="line">Ew5Hb2xkZW5Gcm9nLUluYzEaMBgGA1UEAxMRR29sZGVuRnJvZy1JbmMgQ0ExIzAh</span><br><span class="line">BgkqhkiG9w0BCQEWFGFkbWluQGdvbGRlbmZyb2cuY29tMIIBIjANBgkqhkiG9w0B</span><br><span class="line">AQEFAAOCAQ8AMIIBCgKCAQEA37JesfCwOj69el0AmqwXyiUJ2Bm+q0+eR9hYZEk7</span><br><span class="line">pVoj5dF9RrKirZyCM/<span class="number">9</span>zEvON5z4pZMYjhpzrq6eiLu3j1xV6lX73Hg0dcflweM5i</span><br><span class="line">qxFAHCwEFIiMpPwOgLV399sfHCuda11boIPE4SRooxUPEju908AGg/i+egntvvR2</span><br><span class="line">d7pnZl2SCJ1sxlbeAAkYjX6EXmIBFyJdmry1y05BtpdTgPmTlJ0cMj7DlU+<span class="number">2</span>gehP</span><br><span class="line">ss/q6YYRAhrKtlZwxeunc+RD04ieah+boYU0CBZinK2ERRuAjx3hbCE4b0S6eizr</span><br><span class="line">QmSuGFNu6Ghx+E1xasyl1Tz/fHgHl3P93Jf0tFov7uuygQIDAQABo4H6MIH3MB0G</span><br><span class="line">A1UdDgQWBBTh9HiMh5RnRVIt/ktXddiGkDkXBTCBxwYDVR0jBIG/MIG8gBTh9HiM</span><br><span class="line">h5RnRVIt/ktXddiGkDkXBaGBmKSBlTCBkjELMAkGA1UEBhMCS1kxFDASBgNVBAgT</span><br><span class="line">C0dyYW5kQ2F5bWFuMRMwEQYDVQQHEwpHZW9yZ2VUb3duMRcwFQYDVQQKEw5Hb2xk</span><br><span class="line">ZW5Gcm9nLUluYzEaMBgGA1UEAxMRR29sZGVuRnJvZy1JbmMgQ0ExIzAhBgkqhkiG</span><br><span class="line"><span class="number">9</span>w0BCQEWFGFkbWluQGdvbGRlbmZyb2cuY29tggkA13ZTC3tJpuwwDAYDVR0TBAUw</span><br><span class="line">AwEB/zANBgkqhkiG9w0BAQUFAAOCAQEAwihrN0QNE19RRvGywBvsYDmzmM5G8ta5</span><br><span class="line"><span class="number">8</span>yB+<span class="number">02</span>Mzbm0KuVxnPJaoVy4L4WocAnqLeKfmpYWUid1MPwDPtwtQ00U7QmRBRNLU</span><br><span class="line">hS6Bth1wXtuDvkRoHgymSvg1+wonJNpv/VquNgwt7XbC9oOjVEd9lbUd+ttxzboI</span><br><span class="line"><span class="number">8</span>P1ci6+I861PylA0DOv9j5bbn1oE0hP8wDv3bTklEa612zzEVnnfgw+ErVnkrnk8</span><br><span class="line"><span class="number">8</span>fTiv6NZtHgUOllMq7ymlV7ut+BPp20rjBdOCNn2Q7dNCKIkI45qkwHtXjzFXIxz</span><br><span class="line">Gq3tLVeC54g7XZIc7X0S9avgAE7h9SuRYmsSzvLTtiP1obMCHB5ebQ==</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line">&lt;/ca&gt;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>


<img src="/2018/01/07/setup-split-vpn-on-unifi-usg-using-pbr/create-the-configuration-file-for-openvpn.png" class="">

<h3 id="Adding-openvpn-node-to-interfaces"><a href="#Adding-openvpn-node-to-interfaces" class="headerlink" title="Adding openvpn node to interfaces"></a>Adding openvpn node to interfaces</h3><p>This is the only required change to the config.gateway.json file neccessary to test the OpenVPN client on the USG. Naturally the configuration file must be in place and correct for this to work.</p>
<p>If your config.gateway.json file was empty before this, this is the only content you need. Make sure it is valid json.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"interfaces"</span>: &#123;</span><br><span class="line">        <span class="attr">"openvpn"</span>: &#123;</span><br><span class="line">            <span class="attr">"vtun0"</span>: &#123;</span><br><span class="line">                <span class="attr">"description"</span>: <span class="string">"Giganews OpenVPN"</span>,</span><br><span class="line">                <span class="attr">"config-file"</span>: <span class="string">"/config/openvpn/gateway.ovpn"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>




<img src="/2018/01/07/setup-split-vpn-on-unifi-usg-using-pbr/adding-openvpn-node-to-interfaces.png" class="">

<h3 id="Verifying"><a href="#Verifying" class="headerlink" title="Verifying"></a>Verifying</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh <span class="symbol">admin@</span><span class="number">10.0</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">show <span class="built_in">int</span>erfaces</span><br><span class="line"> </span><br></pre></td></tr></table></figure>




<img src="/2018/01/07/setup-split-vpn-on-unifi-usg-using-pbr/verifying.png" class="">

<h2 id="Overview-of-the-changes-to-config-gateway-json"><a href="#Overview-of-the-changes-to-config-gateway-json" class="headerlink" title="Overview of the changes to config.gateway.json"></a>Overview of the changes to config.gateway.json</h2><p>My existing config.gateway.json already contains configuration to host names, in order to ease initial setup and point static host names to my specific subnet and ip (setup.ubnt.com -&gt; USG ip). I do L3 adoption in additon to running inside Docker, which is problematic in the initial setup process for a USG.</p>
<p><strong>Interfaces</strong></p>
<p>We will add a new interface, a openvpn node and specifically vtun0 interface. We could add the configuration inside this node, but it is easier to just point out a specific configuration file which lives on the USG. This way we can make changes and updates and not need to reprovision anything.</p>
<p>We also need to specify which <em>modify</em> rule on our existing LAN configuration, which allows us to reroute all requests from inside our LAN which comes from specific ip addresses.</p>
<p><strong>Firewall</strong></p>
<p>In the firewall node we add a named group, which we will dynamically populate with ip addresses we want to reroute, thanks to the UI from Detour. If you don’t use Detour, you can instead add specific addresses or a range.</p>
<p>We also specify the actual named <em>modify</em> logic, which reroutes based on source ip.</p>
<p><strong>Protocols</strong></p>
<p>The protocols section contains the actual routing information used by the above <em>modify</em> firewall rule. Since we want to only reroute traffic for some devices, we define a separate interface-route to use in those cases. All other traffic is using the default routing and gateway.</p>
<p><strong>Service</strong></p>
<p>The service node contains the masquerade nat rule for the VPN. This magically solves how traffic sent out from the VPN makes it back through to us.</p>
<img src="/2018/01/07/setup-split-vpn-on-unifi-usg-using-pbr/overview-of-the-changes-to-configgatewayjson.png" class="">

<h3 id="The-config-gateway-json-configuration"><a href="#The-config-gateway-json-configuration" class="headerlink" title="The config.gateway.json configuration"></a>The config.gateway.json configuration</h3><p>The USG is not allowing an empty value for the firewall group address-group node, so I’ve put an initial value there to get passed this bug. This may change in future firmware upgrades. If the configuration cannot be set on the USG, the controller provision process goes into an endless loop of trying to applying the configuration.</p>
<p>eth1 is my LAN port</p>
<p>The nat rule can actually be done via UI, but I’m including it here to keep all settings in one place. Make sure all keys and index number are free to use and adjust if neccessary.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"firewall"</span>: &#123;</span><br><span class="line">        <span class="attr">"group"</span>: &#123;</span><br><span class="line">            <span class="attr">"address-group"</span>: &#123;</span><br><span class="line">                <span class="attr">"vypr_nyc"</span>: &#123;</span><br><span class="line">                    <span class="attr">"address"</span>: [</span><br><span class="line">                        <span class="string">"10.0.1.254"</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"modify"</span>: &#123;</span><br><span class="line">            <span class="attr">"detour"</span>: &#123;</span><br><span class="line">                <span class="attr">"rule"</span>: &#123;</span><br><span class="line">                    <span class="attr">"10"</span>: &#123;</span><br><span class="line">                        <span class="attr">"action"</span>: <span class="string">"modify"</span>,</span><br><span class="line">                        <span class="attr">"description"</span>: <span class="string">"Detour route to Giganews/Vypr VPN"</span>,</span><br><span class="line">                        <span class="attr">"modify"</span>: &#123;</span><br><span class="line">                            <span class="attr">"table"</span>: <span class="string">"1"</span></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="attr">"source"</span>: &#123;</span><br><span class="line">                            <span class="attr">"group"</span>: &#123;</span><br><span class="line">                                <span class="attr">"address-group"</span>: <span class="string">"vypr_nyc"</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"interfaces"</span>: &#123;</span><br><span class="line">        <span class="attr">"ethernet"</span>: &#123;</span><br><span class="line">            <span class="attr">"eth1"</span>: &#123;</span><br><span class="line">                <span class="attr">"firewall"</span>: &#123;</span><br><span class="line">                    <span class="attr">"in"</span>: &#123;</span><br><span class="line">                        <span class="attr">"modify"</span>: <span class="string">"detour"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"openvpn"</span>: &#123;</span><br><span class="line">            <span class="attr">"vtun0"</span>: &#123;</span><br><span class="line">                <span class="attr">"description"</span>: <span class="string">"Giganews OpenVPN"</span>,</span><br><span class="line">                <span class="attr">"config-file"</span>: <span class="string">"/config/openvpn/gateway.ovpn"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"protocols"</span>: &#123;</span><br><span class="line">        <span class="attr">"static"</span>: &#123;</span><br><span class="line">            <span class="attr">"table"</span>: &#123;</span><br><span class="line">                <span class="attr">"1"</span>: &#123;</span><br><span class="line">                    <span class="attr">"interface-route"</span>: &#123;</span><br><span class="line">                        <span class="attr">"0.0.0.0/0"</span>: &#123;</span><br><span class="line">                            <span class="attr">"next-hop-interface"</span>: &#123;</span><br><span class="line">                                <span class="attr">"vtun0"</span>: <span class="string">"''"</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"service"</span>: &#123;</span><br><span class="line">        <span class="attr">"nat"</span>: &#123;</span><br><span class="line">            <span class="attr">"rule"</span>: &#123;</span><br><span class="line">                <span class="attr">"5004"</span>: &#123;</span><br><span class="line">                    <span class="attr">"description"</span>: <span class="string">"Masquerade for Giganews OpenVPN"</span>,</span><br><span class="line">                    <span class="attr">"outbound-interface"</span>: <span class="string">"vtun0"</span>,</span><br><span class="line">                    <span class="attr">"type"</span>: <span class="string">"masquerade"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>




<h2 id="Restart-OpenVPN-client"><a href="#Restart-OpenVPN-client" class="headerlink" title="Restart OpenVPN client"></a>Restart OpenVPN client</h2><p>Sometimes you need to restart the OpenVPN client, which can be done by disabling and then enabling the interface like this. The commit statements are key here which will bounce the interface. </p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">configure</span><br><span class="line"><span class="keyword">set</span> interfaces openvpn vtun0 <span class="keyword">disable</span></span><br><span class="line"><span class="keyword">commit</span></span><br><span class="line"><span class="keyword">delete</span> interfaces openvpn vtun0 <span class="keyword">disable</span></span><br><span class="line"><span class="keyword">commit</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure>




<img src="/2018/01/07/setup-split-vpn-on-unifi-usg-using-pbr/restart-openvpn-client.png" class="">

<h2 id="Quick-speedtest-result"><a href="#Quick-speedtest-result" class="headerlink" title="Quick speedtest result"></a>Quick speedtest result</h2><p>A quick speed test gives the following: Laptop -&gt; Wifi -&gt; USG -&gt; VPN -&gt; NYC USA endpoint -&gt; Stockholm Sweden and roundtrip.</p>
<img src="/2018/01/07/setup-split-vpn-on-unifi-usg-using-pbr/quick-speedtest-result.png" class="">
        </div>
        <footer class="article-footer">
            


    <div class="a2a_kit a2a_default_style">
    <a class="a2a_dd" href="https://www.addtoany.com/share" target="_blank" rel="noopener">Share</a>
    <span class="a2a_divider"></span>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_pinterest"></a>
    <a class="a2a_button_tumblr"></a>
</div>
<script type="text/javascript" src="//static.addtoany.com/menu/page.js"></script>
<style>
    .a2a_menu {
        border-radius: 4px;
    }
    .a2a_menu a {
        margin: 2px 0;
        font-size: 14px;
        line-height: 16px;
        border-radius: 4px;
        color: inherit !important;
        font-family: 'Microsoft Yahei';
    }
    #a2apage_dropdown {
        margin: 10px 0;
    }
    .a2a_mini_services {
        padding: 10px;
    }
    a.a2a_i,
    i.a2a_i {
        width: 122px;
        line-height: 16px;
    }
    a.a2a_i .a2a_svg,
    a.a2a_more .a2a_svg {
        width: 16px;
        height: 16px;
        line-height: 16px;
        vertical-align: top;
        background-size: 16px;
    }
    a.a2a_i {
        border: none !important;
    }
    a.a2a_menu_show_more_less {
        margin: 0;
        padding: 10px 0;
        line-height: 16px;
    }
    .a2a_mini_services:after{content:".";display:block;height:0;clear:both;visibility:hidden}
    .a2a_mini_services{*+height:1%;}
</style>


        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>

                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>follow:</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="youtube" href="https://youtube.com" target="_blank">
                        <i class="icon fa fa-youtube"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/mry" target="_blank">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="linkedin" href="https://www.linkedin.com" target="_blank">
                        <i class="icon fa fa-linkedin"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/atom.xml" target="_blank">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2018/01/09/install-plex-on-synology-nas-using-docker-compose/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">newer</strong>
        <p class="article-nav-title">
        
            Install PLEX on Synology NAS Using Docker Compose
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2017/11/13/install-nvm-as-a-oh-my-zsh-plugin/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">older</strong>
        <p class="article-nav-title">Install Nvm as a Oh-My-Zsh Plugin</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                
    <div class="widget-wrap">
        <h3 class="widget-title">recents</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2020/04/28/add-lets-encrypt-certificate-to-vcenter-7/" class="thumbnail">
    
    
        <span style="background-image:url(/2020/04/28/add-lets-encrypt-certificate-to-vcenter-7/chainoftrust.png)" alt="Add Let&#39;s Encrypt Certificate to vCenter 7" class="thumbnail-image"></span>
    
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2020/04/28/add-lets-encrypt-certificate-to-vcenter-7/" class="title">Add Let&#39;s Encrypt Certificate to vCenter 7</a></p>
                            <p class="item-date"><time datetime="2020-04-28T18:52:09.000Z" itemprop="datePublished">2020-04-28</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/08/03/setup-cloudflare-access/" class="thumbnail">
    
    
        <span style="background-image:url(/2018/08/03/setup-cloudflare-access/238b904a-3b2c-413c-aad4-85a62a7e72b3.png)" alt="Setup Cloudflare Access" class="thumbnail-image"></span>
    
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2018/08/03/setup-cloudflare-access/" class="title">Setup Cloudflare Access</a></p>
                            <p class="item-date"><time datetime="2018-08-03T18:55:32.000Z" itemprop="datePublished">2018-08-03</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/08/03/using-github-pages-as-web-host-and-cloudflare-as-cdn/" class="thumbnail">
    
    
        <span style="background-image:url(/2018/08/03/using-github-pages-as-web-host-and-cloudflare-as-cdn/662949ef-1d9a-4b56-bc56-5e26c9936cf1.png)" alt="Using GitHub Pages as Web Host and Cloudflare as CDN" class="thumbnail-image"></span>
    
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2018/08/03/using-github-pages-as-web-host-and-cloudflare-as-cdn/" class="title">Using GitHub Pages as Web Host and Cloudflare as CDN</a></p>
                            <p class="item-date"><time datetime="2018-08-03T18:15:14.000Z" itemprop="datePublished">2018-08-03</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/07/28/install-windows-admin-center-on-windows-server-2016-core/" class="thumbnail">
    
    
        <span style="background-image:url(/2018/07/28/install-windows-admin-center-on-windows-server-2016-core/76faea3f-0cac-4ad4-be02-62db289a26df.jpg)" alt="Install Windows Admin Center on Windows Server 2016 Core" class="thumbnail-image"></span>
    
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2018/07/28/install-windows-admin-center-on-windows-server-2016-core/" class="title">Install Windows Admin Center on Windows Server 2016 Core</a></p>
                            <p class="item-date"><time datetime="2018-07-28T10:19:36.000Z" itemprop="datePublished">2018-07-28</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/07/21/local-https-dev-proxy-using-lets-encrypt-and-cloudflare/" class="thumbnail">
    
    
        <span style="background-image:url(/2018/07/21/local-https-dev-proxy-using-lets-encrypt-and-cloudflare/b8fd7d88-5173-425f-8a2b-d9e08c03e89d.png)" alt="Local HTTPS Dev Proxy Using Lets Encrypt and Cloudflare" class="thumbnail-image"></span>
    
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2018/07/21/local-https-dev-proxy-using-lets-encrypt-and-cloudflare/" class="title">Local HTTPS Dev Proxy Using Lets Encrypt and Cloudflare</a></p>
                            <p class="item-date"><time datetime="2018-07-21T08:05:15.000Z" itemprop="datePublished">2018-07-21</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/aws/" style="font-size: 10px;">aws</a> <a href="/tags/azure/" style="font-size: 10px;">azure</a> <a href="/tags/backup/" style="font-size: 10px;">backup</a> <a href="/tags/blog/" style="font-size: 11.11px;">blog</a> <a href="/tags/cdn/" style="font-size: 13.33px;">cdn</a> <a href="/tags/cloudflare/" style="font-size: 15.56px;">cloudflare</a> <a href="/tags/crashplan/" style="font-size: 12.22px;">crashplan</a> <a href="/tags/dev/" style="font-size: 10px;">dev</a> <a href="/tags/digitalocean/" style="font-size: 11.11px;">digitalocean</a> <a href="/tags/dns/" style="font-size: 12.22px;">dns</a> <a href="/tags/docker/" style="font-size: 18.89px;">docker</a> <a href="/tags/docs/" style="font-size: 10px;">docs</a> <a href="/tags/edgerouter/" style="font-size: 11.11px;">edgerouter</a> <a href="/tags/esxi/" style="font-size: 16.67px;">esxi</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/github/" style="font-size: 12.22px;">github</a> <a href="/tags/hexo/" style="font-size: 15.56px;">hexo</a> <a href="/tags/howto/" style="font-size: 20px;">howto</a> <a href="/tags/letsencrypt/" style="font-size: 12.22px;">letsencrypt</a> <a href="/tags/nas/" style="font-size: 11.11px;">nas</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/nvm/" style="font-size: 10px;">nvm</a> <a href="/tags/oauth/" style="font-size: 10px;">oauth</a> <a href="/tags/osx/" style="font-size: 13.33px;">osx</a> <a href="/tags/photon/" style="font-size: 14.44px;">photon</a> <a href="/tags/plex/" style="font-size: 12.22px;">plex</a> <a href="/tags/rpi/" style="font-size: 10px;">rpi</a> <a href="/tags/s3/" style="font-size: 10px;">s3</a> <a href="/tags/splunk/" style="font-size: 10px;">splunk</a> <a href="/tags/ssh/" style="font-size: 11.11px;">ssh</a> <a href="/tags/ssl/" style="font-size: 14.44px;">ssl</a> <a href="/tags/synology/" style="font-size: 17.78px;">synology</a> <a href="/tags/sysop/" style="font-size: 10px;">sysop</a> <a href="/tags/ubnt/" style="font-size: 15.56px;">ubnt</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/unifi/" style="font-size: 14.44px;">unifi</a> <a href="/tags/usg/" style="font-size: 10px;">usg</a> <a href="/tags/vmware/" style="font-size: 18.89px;">vmware</a> <a href="/tags/vpn/" style="font-size: 11.11px;">vpn</a> <a href="/tags/vsan/" style="font-size: 11.11px;">vsan</a> <a href="/tags/vscode/" style="font-size: 10px;">vscode</a> <a href="/tags/web/" style="font-size: 11.11px;">web</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a> <a href="/tags/windows-core/" style="font-size: 10px;">windows_core</a> <a href="/tags/zsh/" style="font-size: 11.11px;">zsh</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">links</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io" target="_blank" rel="noopener">Hexo</a>
                    </li>
                
                    <li>
                        <a href="https://github.com/ppoffice/hexo-theme-hueman" target="_blank" rel="noopener">Hueman theme</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>
                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2020 emryl</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_shortname = 'emryl';
    
    
    var disqus_url = 'https://blog.rylander.io/2018/01/07/setup-split-vpn-on-unifi-usg-using-pbr/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>



    
        
<script src="/vendor/fancybox/jquery.fancybox.pack.js"></script>

    

    
        
<script src="/vendor/scrollLoading/jquery.scrollLoading.js"></script>

        
<script src="/vendor/scrollLoading/main.js"></script>

    


<!-- Custom Scripts -->

<script src="/js/main.js"></script>


    </div>
</body>
</html>
